---
title: "Data Preparation"
author: "Sebastian Sauer"
date: "5 8 2017"
output: html_document
---




```{r setup, include=FALSE}

opts_knit$set(root.dir = normalizePath('../'))


knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      fig.align = "center",
                      cache = TRUE,
                      root.dir = )
```



# Warmup


First load some libraries.

```{r}
library(tidyverse)
library(readr)
library(lubridate)
```


And the data - raw data.

```{r load-raw-data}
getwd()
load("../data_polit_twitter/raw/tweets_polits_raw.Rdata")

polits_df <- read_csv("../data_polit_twitter/raw/german_politicians_twitter_raw.csv")
```





# Join parties-df 



Convert to lower_case
```{r}

polits_df %>% 
  mutate(party = str_to_lower(party)) -> polits_df
```

Check if the screename is *not* preceded by an asterisk '@':

```{r}
polits_df %>% pull(screenName) %>% head
```

Otherwise, change in raw data file (exclude '@').


Glimpse

```{r}
polits_df %>% 
  glimpse
```



```{r}
polits_df %>% 
  dplyr::select(screenName, party) -> polits_parties

tweets_polits_raw %>% 
  left_join(polits_parties, by = "screenName") -> tweets_polits


```

Glimpse:

```{r}
tweets_polits %>% glimpse
```




# Join party data to acount names


Repair some merging errors - run only if necessary.

```{r eval = FALSE}
tweets_polits_raw %>% 
  select(-c(human.x, human.y, party, name.y),
           name = name.x) -> tweets_polits_raw

names(tweets_polits_raw)
```



## How many tweets (initially)?

```{r}
tweets_polits %>% 
  nrow
```


## Save this updated data (joined with party names)

```{r}
save(tweets_polits, file = "../data_polit_twitter/raw/tweets_polits_with_party_names.RData")
```



## Erase duplicates

```{r eval = FALSE}

# do NOT run
tweets_polits %>% 
  #group_by(screenName) %>% 
  mutate(is_duplicate = duplicated(id)) %>% 
  filter(!is_duplicated) -> tweets_with_bug

nrow(tweets_with_bug)  # ~62k
```

The code above erased way too many tweets. There is some bug. Don't use this output.

Proportion of tweets left (non-duplicates): `r nrow(tweets2)/nrow(tweets_polits)`.

This code works:

```{r cache = TRUE}
tweets_polits %>% 
  group_by(id) %>% 
  filter(row_number() == 1) %>% 
  ungroup -> tweets_df

tweets_df %>% 
  nrow  # ~380k
```




Proportion of tweets left (non-duplicates): `r nrow(tweets_df)/nrow(tweets_polits)`.







# Ensure UTF8


```{r}
Encoding(tweets_df$text) <- "UTF8"
tweets_df$text <- stringi::stri_enc_toutf8(tweets_df$text)
tweets_df$screenName <- stringi::stri_enc_toutf8(tweets_df$screenName)
tweets_df$party <- stringi::stri_enc_toutf8(tweets_df$party)
```





# Tweet duration

Get oldest and newst tweet per screenName. The difference between is the `tweet period`.

```{r}
tweets_df %>% 
  group_by(screenName) %>% 
  summarise(first_tweet = min(created),
            recent_tweet = max(created)) %>% 
  mutate(tweet_period = (recent_tweet - first_tweet) / ddays(1)) -> polits_tweet_times

names(polits_tweet_times)

```


Merge this information to the dataset of the politicians `polits_df`.

```{r}

names(polits_df)

polits_df %>% 
 left_join(polits_tweet_times, by = "screenName") -> polits_df

names(polits_df)

```


Merge this to the `tweets_df` dataframe.

```{r}
names(tweets_df)
tweets_df %>% 
  select(-c(first_tweet, recent_tweet, tweet_period)) %>%
  left_join(polits_tweet_times, by = "screenName") -> tweets_df

names(tweets_df)
```



# Join the number of tweets to the `polits_df`


Join the info on the number of tweets to the polits_df.

```{r}
tweets_df %>% 
  group_by(screenName) %>% 
  summarise(n = n()) %>% 
  left_join(polits_df, by = "screenName") -> polits_df
  
```



# Daily tweets

```{r}
polits_df %>% 
  mutate(daily_tweets_n = n / tweet_period,
         yearly_tweets_n = daily_tweets_n * 365) -> polits_df
```





# Check

```{r}

```


# Correct typo

```{r}
tweets_df %>% 
  mutate(party = recode(party, Grune = "Gruene")) -> tweets_df


polits_df %>% 
  mutate(party = recode(party, Grune = "Gruene")) -> polits_df

  
```



# Save data

```{r}
write_csv(polits_df, path = "../data_polit_twitter/polits_df.csv")
save(tweets_df, file = "../data_polit_twitter/tweets_df.Rdata")
```

